#!/usr/bin/env bash

################################################################################
CURRENT_DIR=$(dirname $(readlink -f $0))
source $CURRENT_DIR/env
source $CURRENT_DIR/lib
################################################################################

PROJECT_BLOG=demo-kwok.github.io

DIR_BLOG=$SHAMAN_ROOT/blog
DIR_WORKSPACE=$SHAMAN_ROOT/workspace
DIR_LLVM_WHERE=$SHAMAN_ROOT/dev
DIR_LLVM=$SHAMAN_ROOT/dev/llvm

################################################################################
function run-emacs {
    if [ ! -f $HOME/.emacs ]; then
		link-init-el
    fi

    emacs --debug-init
    exit
}

function run-emacs-nw {
    if [ ! -f $HOME/.emacs ]; then
		link-init-el
    fi

    emacs -nw --debug-init
}

function delete-etc {
    cd $SHAMAN_ROOT/emacs-config/modules
    rm -rf *.elc
    cd $SHAMAN_ROOT
}

function link-init-el() {
    tip "link"
    # cp -rf $SHAMAN_ROOT/emacs-config/init.el $HOME/.emacs

    bkdir=~/emacs-config-backup/`date +%Y-%m-%d@%H-%M-%S`
    mkdir -p $bkdir

    if [ -e ~/.emacs ]; then
		mv ~/.emacs $bkdir
    fi

    if [ -e ~/.emacs.d ]; then
		mv -a ~/.emacs.d $bkdir
    fi

    if [ -e ~/emacs-config ]; then
		mv ~/emacs-config $bkdir
    fi

    if [ -e ~/workspace ]; then
		mv ~/workspace $bkdir
    fi
    
    if [ -e ~/blog ]; then
		mv ~/blog $bkdir
    fi

    rm ~/.emacs
    rm ~/emacs-config
    rm ~/workspace
    rm ~/blog

    #for linux
    tip "link .emacs"
    cp -a $SHAMAN_ROOT/emacs-config/init.el ~/.emacs 
    ln -s $SHAMAN_ROOT/emacs-config ~/emacs-config
    ln -s $SHAMAN_ROOT/workspace ~/workspace
    ln -s $SHAMAN_ROOT/blog ~/blog
	
    # if [ ! -f /usr/bin/shaman ]; then
    # sudo ln -s $SHAMAN_ROOT/shaman /usr/bin/shaman
    # fi

    find-str ".shaman" ~/.bashrc
    if [ $? -eq 0 ]; then
		echo "" >> ~/.bashrc
		echo "source $SHAMAN_BIN/env" >> ~/.bashrc
    fi

    # find-str ".shaman" ~/.zshrc
    # if [ $? -eq 0 ]; then
		# echo "" >> ~/.zshrc
		# echo "source $SHAMAN_BIN/env" >> ~/.zshrc
    # fi

	find-str ".shaman" ~/.profile
    if [ $? -eq 0 ]; then
		echo "" >> ~/.profile 
		# echo "export PATH=$SHAMAN_ROOT:$SHAMAN_BIN:\$PATH" >> ~/.profile 
		echo "source $SHAMAN_BIN/env" >> ~/.profile 
    fi
    
    # source $SHAMAN_BIN/env.sh
	
    pull-blog
}

function pull-blog {
    # cd $SHAMAN_ROOT
    # git reset
    # git pull

    tip "blog"
    if [ ! -d $DIR_BLOG ]; then
		cd $SHAMAN_ROOT
		git clone https://github.com/damon-kwok/damon-kwok.github.io.git $DIR_BLOG
    else
		cd $DIR_BLOG
		git pull
    fi

    tip "pull workspace"
    if [ ! -d $DIR_WORKSPACE ]; then
		cd $SHAMAN_ROOT
		svn co svn://www.svn999.com/guowangwei.workspace workspace
    else
		cd $DIR_WORKSPACE
		svn cleanup .
		svn up
    fi

}

function push-blog {
    tip "push-blog"
    cd $SHAMAN_ROOT/blog
    git reset
    git pull
    git add .
    git status
    git commit -m `date +%Y-%m-%d@%H-%M-%S` # "upgrade by "`uname -n`
    git push -u origin master
}

function zipapp {
    tip "zipapp"
    cd $CACHE
    zip -r apps.zip apps
    mv apps.zip $ZIP_HOME/apps.zip
    cd $ZIP_HOME
    rm -rf *.zip.*
    split -d -b 3m apps.zip apps.zip.
    sleep 1s
    rm -rf apps.zip

    cd $SHAMAN_ROOT
}

function unzipapp {
    tip "unzipapp"
    cd $ZIP_HOME
    ls
    cat *.zip.* > apps.zip
    unzip apps.zip
    sleep 1s
    rm -rf apps.zip
    mv apps ..

    cd $SHAMAN_ROOT
}

function pushapp {
    tip "pushapp"
    cd $ZIP_HOME
    zipapp
    git-push
}

function getapp {
    tip "getapp"
    if [ ! -d $APP_HOME ]; then
		if [ ! -d $ZIPHOME ]; then
			echo pass
		fi
    fi
}

function ask-blog {
    echo ""
    tip "please choose your choice:"
    echo "    1) pull-blog"
    echo "    2) push-blog"
    echo "    3) commit-workspace"
    echo "    s) shell"    
    echo ------------------------------------
    echo "    r) return"

    read -p "please enter your choice:" item
    case $item in
		1) pull-blog;;
		2) push-blog;;
		3)
			# mkdir -p ~/tmp/
			# mv $DIR_WORKSPACE/catkin_ws/.git/ ~/tmp/
			# rm -rf  $DIR_WORKSPACE/catkin_ws/src/adsim/rtags_indexes
			# rm -rf $DIR_WORKSPACE/catkin_ws/build/
			# rm -rf $DIR_WORKSPACE/catkin_ws/devel/lib/
			# rm -rf $DIR_WORKSPACE/catkin_ws/devel/share/
			
			cd $DIR_WORKSPACE
			svn-commit
	    
	    # mv ~/tmp/.git/ $DIR_WORKSPACE/catkin_ws/
	    ;;
	s|S) bash;;
	r|R) ask-menu;;
	*) ask-blog;;
    esac
}

function ask-repl {
    echo ""
    tip "please choose your choice:"
    echo "    1) clojure"
    echo "    2) haskell"
    echo "    3) elixir"
    echo "    4) erlang"
    echo "    -------------------------"
    echo "    r) return"

    read -p "please enter your choice:" item
    case $item in
	1) echo abort with "^C | ^D | (exit) | (quit)" && lein repl;;
	2) echo abort with "^D :quit" && stack repl;;
	3) echo abort with "^C" && iex;;
	4) echo abort with "^C | ^G | q()." && erl;;
	r | R) ask-menu;;
	*) ask-repl;;
    esac
}

function ask-menu {
    cd $SHAMAN_ROOT
    #echo "ask-menu"
    # echo "    0) ask-blog"
    echo "=============================="
    echo "    1) pull"
    echo "    2) push"
    # echo "    2) getapp"
    # echo "    3) pushapp"
    # echo "    4) zipapp"
    # echo "    5) unzipapp"
    echo "    i) install toolchain"
    echo "    g) git config"
    echo "    e) emacs"
    echo "    n) emacs-nw"
    # echo "    c) complie-elc"
    echo "    l) link init.el"
    echo "    d) delete-elc"
    echo "    --------------------------"
    echo "    r) return"
    echo "    s) shell"
    echo "    z) REPL"
    echo "    q) quit"

	cd $SHAMAN_ROOT
    read -p "please enter your choice:" item
    case $item in
	0) ask-blog;;
	1) git-pull;;
	2) git-push;;
	3) git-push-a;;
	# 2) getapp;;
	# 3) pushapp;;
	# 4) zipapp;;
	# 5) unzipapp;;
	i) install-toolchain;;
	g|G)
	    git config --global color.ui true
	    git config --global core.editor "ed"
	    
	    git config --global merge.tool ediff-merge
	    git config --global mergetool.diffmerge.cmd "ediff-merge \$LOCAL \$REMOTE \$BASE \$MERGED"
	    git config --global mergetool.keepBackup false

	    git config --global diff.tool ediff
	    git config --global difftool.ediff.cmd "ediff \"\$LOCAL\" \"\$REMOTE\""
	    git config --global difftool.prompt false
	    ;;
	e|E) run-emacs;;
	n|N) run-emacs-nw;;
	c|C) compile-elc;;
	l|L) link-init-el;;
	d|D) delete-elc;;
	s|S) bash;;
	z|Z) ask-repl;;
	q|Q) exit;;
	*) ask-menu;;	    
    esac
    ask-menu
}

ask-menu
