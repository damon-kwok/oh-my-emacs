#!/usr/bin/env bash

SHAMAN_DIR_NAME=my-emacs-config
SHAMAN_ROOT=`cd ~/$SHAMAN_DIR_NAME; pwd`
SHAMAN_BIN=$SHAMAN_ROOT/bin

DIR_BLOG=$SHAMAN_ROOT/blog
DIR_WORKSPACE=$SHAMAN_ROOT/workspace
################################################################################

function find-str {    
    grep $1 $2 >/dev/null
    if [ $? -eq 0 ]; then
	return $(( 1 ));
    else
	return $(( 0 ));
    fi
}

function readp {
    read -p "$1(Y/n)" c
    if [ "$c" == "y" ] || [ "$c" == "Y" ] || [ "$c" == "" ]; then
	return $(( 1 ));
    elif [ "$c" == "n" ] || [ "$c" == "N" ]; then
	return $(( 0 ));
    else
	echo "invalid input:$c"
	readp "$1"
    fi
}

################################################################################

function pull-blog {
    cd $SHAMAN_ROOT
    git reset
    git pull
    
    echo blog
    if [ ! -d $DIR_BLOG ]; then
	cd $SHAMAN_ROOT
	git clone https://github.com/damon-kwok/damon-kwok.github.io.git blog
    else
	cd $DIR_BLOG
	git pull
    fi

    echo workspace
    if [ ! -d $DIR_WORKSPACE ]; then
	cd $SHAMAN_ROOT
	svn co svn://www.svn999.com/guowangwei.workspace workspace
    else
	cd $DIR_WORKSPACE
	svn cleanup .
	svn up
    fi

}

function link-init-el() {
    bkdir=~/emacs-config-backup/`date +%Y-%m-%d@%H-%M-%S`

    if [ -f ~/.emacs ]; then
	mkdir -p $bkdir
	mv ~/.emacs $bkdir
    fi

    if [ -f ~/.emacs.d ]; then
	mkdir -p $bkdir
	mv -a ~/.emacs.d $bkdir
    fi

    if [ -e ~/emacs-config ]; then
	mkdir -p $bkdir
	mv ~/emacs-config $bkdir
    fi

    if [ -e ~/workspace ]; then
	mkdir -p $bkdir
	mv ~/workspace $bkdir
    fi
    
    if [ -e ~/blog ]; then
	mkdir -p $bkdir
	mv ~/blog $bkdir
    fi

    #for linux
    echo link
    cp -a $SHAMAN_ROOT/emacs-config/init.el ~/.emacs 
    ln -s $SHAMAN_ROOT/emacs-config ~/emacs-config
    ln -s $SHAMAN_ROOT/workspace ~/workspace
    ln -s $SHAMAN_ROOT/blog ~/blog

    find-str "my-emacs-config" ~/.bashrc
    if [ $? -eq 0 ]; then
	echo "" >> ~/.bashrc
	echo "source $SHAMAN_BIN/setup.sh" >> ~/.bashrc
    fi

    find-str "my-emacs-config" ~/.zshrc
    if [ $? -eq 0 ]; then
	echo "" >> ~/.zshrc
	echo "source $SHAMAN_BIN/setup.sh" >> ~/.zshrc
    fi
    source $SHAMAN_BIN/setup.sh
    
    pull-blog
}

link-init-el
